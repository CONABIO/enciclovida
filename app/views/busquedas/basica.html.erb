<script src="http://www.google.com/jsapi" type="text/javascript" data-turbolinks-track="true"></script>
<script type="text/javascript" charset="utf-8" data-turbolinks-track="true">

    function firstToUpperCase( str ) {
        return str.substr(0, 1).toUpperCase() + str.substr(1);
    }

    soulmate_asigna = function()
    {
        var types = eval("<%=raw CategoriaTaxonomica.categorias_redis('com') %>");
        var render = function(term, data, type, index, id){

            if (I18n.locale == 'es-cientifico')
            {
                var nombres = '<h5> ' + data.nombre_comun + '</h5>' + '<a href="" class="not-active">' + data.nombre_cientifico + ' </a><i>' + data.autoridad + '</i>';
                return nombres;
            } else {
                var nombres = '<h5>'+firstToUpperCase(data.nombre_comun)+'</h5>' + '<a href="" class="not-active">' + data.nombre_cientifico +'</a>';

                if (data.foto.length == 0)
                    var foto = '<i class="soulmate-img ev1-ev-icon pull-left"></i>';
                else {
                    var foto_url = data.foto;
                    var foto = "<i class='soulmate-img pull-left' style='background-image: url(\""+foto_url+"\")';></i>";
                }
                var iconos = ""
                var ev = '-ev-icon'
                $.each(data.cons_amb_dist, function(i, val){
                    if (val == 'exotica' || val == 'invasora' || val == 'exotica-invasora' || val == 'no-endemica'){return true}
                    iconos = iconos + "<i class='" + val + ev +"' title='"+firstToUpperCase(val)+"'></i>"
                });
                if (data.geodatos != undefined){iconos = iconos + "<i class='globe-ev-icon text-success' title='Tiene mapa'></i>"}
                if (data.fotos > 0){iconos = iconos + "<i class='picture-ev-icon text-success' title='Tiene imágenes'></i><sub>" + data.fotos + "</sub>"}
                return foto + " " + nombres + "<h5 class='soulmate-icons'>" + iconos +"</h5>";
            }
        };
        var select = function(term, data, type){
            $('#nombre').val(term);
            $('#id').attr('value', data.id);

            // Para no pasar por el controlador de busquedas, ir directo a la especie
            $('#basica').attr('action','/especies/'+data.id)
            $('#basica').submit();
        };

        $('#nombre').soulmate({
            url:            "http://<%= IP %>:<%= PORT %>sm/search",
            types:          types,
            renderCallback: render,
            selectCallback: select,
            minQueryLength: 2,
            maxResults:     15
        });
    };
</script>

<% if I18n.locale.to_s != 'es-cientifico' %>
    <style type="text/css">
        .soulmate-type-suggestions li{
            padding: 1em 0;
            min-height: 125px;
        }
    </style>
<% end %>

<%= form_tag busquedas_resultados_url, :method => :get, :id => :basica, :class => 'form-horizontal', :role => 'form' do %>
    <%= hidden_field_tag :busqueda, :basica %>
    <%= hidden_field_tag :id %>

    <div class="form-group">
      <div class="input-group">
        <%= text_field_tag :nombre, nil, :maxlength => 255, :placeholder => 'Escribe un nombre común o científico ...', :autocomplete => :off, :class => 'form-control', :value => params[:busqueda] == 'nombre_comun' ? params[:nombre_comun] : nil %>
        <div class="input-group-btn">
          <%= button_tag "<span class='glyphicon glyphicon-search' aria-hidden='true'></span>".html_safe, data: { disable_with: 'Procesando...' },:class => "btn btn-success busquedas btn-title", :title=>'Buscar' %>
          <%= link_to "<span class='glyphicon glyphicon-filter' aria-hidden='true'></span>".html_safe, avanzada_url, :class => "btn btn-warning btn-title", :title => 'Ir a la búsqueda avanzada' %>
        </div>
      </div>
    </div>
<% end %>
