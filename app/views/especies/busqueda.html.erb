<script src="http://www.google.com/jsapi" type="text/javascript" data-turbolinks-track="true"></script>

<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
<script data-turbolinks-track="true" src="/assets/jquery.soulmate.js" data-turbolinks-track="true"></script>
<script type="text/javascript" charset="utf-8" data-turbolinks-track="true">
    guardaFiltros = function ()
    {
        jQuery.ajax({
            fail: function()
            {
                $('#notice').html('Hubo un error con los filtros, por favor intentalo de nuevo.');
            },
            type: 'POST',
            url: '/usuarios/guarda_filtro',
            data: { html: $('#busquedas').html().replace(/\n/g, '') }
        });
        return false;
    }

    estructuraFiltro = function(numeroAtributos)
    {
        var bAtributo, cAtributo, vAtributo, hAtributo, imagenQuitar, anteriores;
        bAtributo="<div id='capa_"+numeroAtributos+"'><select class='busqueda_atributo form-control' name='bAtributo_"+numeroAtributos+"' id='bAtributo_"+numeroAtributos+"'>";
        bAtributo+="<option value='nombre_cientifico'>nombre científico</option>";
        bAtributo+="<option value='nombre_comun'>nombre común</option>";
        bAtributo+="<option value='catalogos.descripcion'>característica del taxón</option>";
        bAtributo+="<option value='nombre_autoridad'>autoridad</option></select> ";

        cAtributo="<select class='busqueda_atributo form-control' name='cAtributo_"+numeroAtributos+"' id='cAtributo_"+numeroAtributos+"'>";
        cAtributo+="<option value='1'>contiene</option>";
        cAtributo+="<option value='2'>empieza con</option>";
        cAtributo+="<option value='3'>igual a</option>";
        cAtributo+="<option value='4'>termina con</option></select> ";

        vAtributo="<input class='busqueda_atributo form-control' name='vAtributo_"+numeroAtributos+"' id='vAtributo_"+numeroAtributos+"' size='30' maxlength='255' type='text' data-autocomplete='/especies/autocomplete_especie_nombre' autocomplete='off' />";
        hAtributo="<input class='busqueda_atributo form-control' name='hAtributo_" + numeroAtributos + "' id='hAtributo_" + numeroAtributos + "' type='hidden' />";
        imagenQuitar="&nbsp;&nbsp;&nbsp;<a onClick='return quitaFiltros(this.id);' id='enlace_filtro_"+numeroAtributos+"' href=''><img src='/assets/app/24x24/delete.png' width='20px;'></a></div>";

        return bAtributo+cAtributo+vAtributo+hAtributo+imagenQuitar;
    }

    masFiltros = function()
    {
        var numeroAtributos = parseInt($("[id^='bAtributo_']:last").attr("id").split('_')[1]) + 1;
        $('#atributos_extra').append(estructuraFiltro(numeroAtributos));
        return false;
    }

    quitaFiltros = function(id)
    {
        $('#capa_'+id.substring(14)).html("");
        return false;
    }

    busqueda_avanzada = function(id)
    {
        $('#busqueda_basica').show();
        $('#busqueda_avanzada').hide();
        $('#busqueda_basica').removeAttr('style').css('display','none');
        $('#busqueda_avanzada').removeAttr('style').css('display','block');
        return false;
    }

    busqueda_basica = function(id)
    {
        $('#busqueda_avanzada').show();
        $('#busqueda_basica').hide();
        $('#busqueda_basica').removeAttr('style').css('display','block');
        $('#busqueda_avanzada').removeAttr('style').css('display','none');
        return false;
    }

    quitaAutocompletar = function()
    {
        $("[id^='vAtributo_']").each(function()
        {
            var id=$(this).attr('id').split('_')[1];
            if ($('#bAtributo_' + id).val() != 'nombre_cientifico' && $('#bAtributo_' + id).val() != 'nombre_comun')
                $(this).removeAttr('data-autocomplete').removeAttr('autocomplete').removeClass('ui-autocomplete-input');
        });
    }

    soulmate_asigna = function(event)
    {
        var campo = document.getElementById(event.target.id);

        if (event.data.num == '1' || event.data.num == '3')         //nombre comun
        {
            var types = eval("<%=raw CategoriaTaxonomica.categorias_redis('com') %>");
            var render = function(term, data, type, index, id, foto)
            {
                event.data.num == '1' ? $('#id_basica_comun').attr('value', '') : $('#id_avanzada_comun').attr('value', '');

                var nombres = I18n.locale == 'es-cientifico' ? '<b>' + term + '</b><br>' + data.nombre_cientifico + ' <i>' + data.autoridad + '</i>' :
                        term + ' <i>(' + data.nombre_cientifico + ')</i>';
                return "<table><tr><td>" + data.foto + "</td><td>" + nombres + "</td></tr></table";
            }
            var select = function(term, data, type)
            {
                $('#'+event.target.id).val(term);
                $('#'+event.target.id).attr('value', term);
                $('ul#soulmate_' + event.data.num).hide();    //esconde el autocomplete
                //pone el ID para mandar a la busqueda directa
                event.data.num == '1' ? $('#id_basica_comun').attr('value', data.id) : $('#id_avanzada_comun').attr('value', data.id)
            }
        }
        if (event.data.num == '2' || event.data.num == '4')          //nombre cientifico
        {
            var types = eval("<%=raw CategoriaTaxonomica.categorias_redis('cien') %>");
            var render = function(term, data, type, index, id, foto)
            {
                event.data.num == '2' ? $('#id_basica_cientifico').attr('value', '') : $('#id_avanzada_cientifico').attr('value', '');

                if (I18n.locale == 'es-cientifico')
                    var nombres = '<b>' + term + '</b> <i>' + data.autoridad + '</i>';
                else
                    var nombres = data.nombre_comun.length == 0 ? '<b><i>' + term + '</i></b>' : data.nombre_comun + ' <i>(<b>' + term + '</b>)</i>';
                return "<table><tr><td>" + data.foto + "</td><td>" + nombres + "</td></tr></table>";
            }
            var select = function(term, data, type)
            {
                $('#'+event.target.id).val(term);
                $('#'+event.target.id).attr('value', term);
                $('ul#soulmate_' + event.data.num).hide();    //esconde el autocomplete
                //pone el ID para mandar a la busqueda directa
                event.data.num == '2' ? $('#id_basica_cientifico').attr('value', data.id) : $('#id_avanzada_cientifico').attr('value', data.id)
            }
        }

        if ($._data(campo, "events") == undefined)
        {        //para que no se repita n-veces la busqueda
            $(campo).soulmate({
                url:            "http://<%= CONFIG.host_ip %>:<%= CONFIG.host_port %>/sm/search",
                types:          types,
                renderCallback: render,
                selectCallback: select,
                minQueryLength: 2,
                maxResults:     5,
                num: event.data.num
            });
        }
    }

    $(document).ready(function()
    {
        $(document).on('click', '.busquedas', function()
        {
            guardaFiltros(false);
        });

        $(document).on('change', "[id^='bAtributo_']", function()
        {
            var valor=$(this).val();
            $('#'+$(this).attr('id') + ' option').removeAttr('selected');
            $('#'+$(this).attr('id') + " option[value='"+valor+"']").attr('selected',true);

            var id=$(this).attr('id').split('_')[1];
            if ($(this).val() == 'nombre_cientifico')
            {
                $('#vAtributo_' + id).attr('data-autocomplete', '/especies/autocomplete_especie_nombre').attr('autocomplete', 'off').addClass('ui-autocomplete-input');
            } else if ($(this).val() == 'nombre_comun')
            {
                $('#vAtributo_' + id).attr('data-autocomplete', '/nombres_comunes/autocomplete_nombre_comun_comun').attr('autocomplete', 'off').addClass('ui-autocomplete-input');
            } else {
                $('#vAtributo_' + id).removeAttr('data-autocomplete').removeAttr('autocomplete').removeClass('ui-autocomplete-input');
            }
            $('#hAtributo_' + id).val('');
        });

        $(document).on('change', "[id^='cAtributo_']", function()
        {
            var valor=$(this).val();
            $('#'+$(this).attr('id') + ' option').removeAttr('selected');
            $('#'+$(this).attr('id') + " option[value='"+valor+"']").attr('selected',true);
        });

        $(document).on('change', "[id^='vAtributo_']", function()
        {
            $(this).attr('value',$(this).val());
            var id=$(this).attr('id').split('_')[1];
            $('#hAtributo_' + id).val('');
        });

        $(document).on('change', ".busqueda_atributo_checkbox", function()
        {
            if ($(this).prop('checked'))
                $(this).attr('checked', true);
            else
                $(this).attr('checked', false);
        });

        $(document).on('change', "[id^='distribucion_nivel_']", function()
        {
            var valor=$(this).val();
            $('#'+$(this).attr('id') + ' option').removeAttr('selected');  //remueve si habia algun seleccionado
            $('#'+$(this).attr('id') + " option[value='"+valor+"']").attr('selected',true);
            var nivel=parseInt($(this).attr('name').substring(19));

            if ($(this).val() != '')
            {
                jQuery.ajax({
                    success: function(html){
                        $('#distribucion_nivel_'+(nivel)).nextAll("[id^='distribucion_nivel_']").remove();
                        switch (nivel)
                        {
                            case 1:
                                $('#distribucion_nivel').empty().html(html);       //pare el inicial
                                break;
                            case 2:
                                $('#distribucion_nivel').append(html);
                                break;
                        }
                    },
                    fail: function(){
                        $('#notice').html('Hubo un error al cargar los filtros, por favor intentalo de nuevo.');
                    },
                    type:'POST',
                    url:'/regiones/regiones',
                    cache:true,
                    data: {region: $(this).val(), region_nivel: nivel}
                });
            }

            if ($(this).val() == '' && nivel == 1)  //quita las sub-regiones si eligio todas
                $('#distribucion_nivel').empty();

            if ($(this).val() == '' && nivel == 2)  //quita las sub-regiones si eligio todas
                $('#distribucion_nivel_3').remove();
        });

        $(document).on('change', "#nombre_comun, #nombre_cientifico, #nombre_comun_1, #nombre_cientifico_1", function()
        {
            var id=$(this).attr('id');
            $(this).attr('value',$(this).val());
        });

        $(document).on('click', '#limpiar', function()
        {
            jQuery.ajax({
                success: function(html)
                {
                    if (html!='true')
                    {
                        $('#notice').html('Hubo un error al limpiar los filtros, por favor intentalo de nuevo.');
                        return false
                    }
                    location.reload(true);
                },
                fail: function() {
                    $('#notice').html('Hubo un error al limpiar los filtros, por favor intentalo de nuevo.');
                },
                type:'POST',
                url:'/usuarios/limpiar',
                cache:true
            });
        });

        $(document).on('change', "#per_page", function(k)
        {
            var valor=$(this).val();
            $('#'+$(this).attr('id') + ' option').removeAttr('selected');
            $('#'+$(this).attr('id') + " option[value='"+valor+"']").attr('selected',true);

            $('#per_page_basica_comun, #per_page_basica_cientifico, #per_page_avanzada').val($(this).val());
            $('#per_page_basica_comun, #per_page_basica_cientifico, #per_page_avanzada').attr('value',$(this).val());

        });

        // autocomplete para la busqueda basica
        $(document).on('focus', '#nombre_comun', {num: "1"}, soulmate_asigna);
        $(document).on('focus', '#nombre_cientifico', {num: "2"}, soulmate_asigna);
        // autocomplete para la busqueda avanzada
        $(document).on('focus', '#nombre_comun_1', {num: "3"}, soulmate_asigna);
        $(document).on('focus', '#nombre_cientifico_1', {num: "4"}, soulmate_asigna);

        // Carga el filtro predeterminado o el de la base
        jQuery.ajax
        ({
            success: function(html)
            {
                $('#busquedas').empty().html(html);
                $('#soulmate_1, #soulmate_2,#soulmate_3, #soulmate_4').remove();
                guardaFiltros(false);
            },
            fail: function()
            {
                $('#notice').html('Hubo un error con los filtros, por favor intentalo de nuevo.');
            },
            type: 'GET',
            url: '/especies/filtros'
        });
    });
</script>

<div id="busquedas"></div>
<script type="text/javascript" data-turbolinks-track="true">
    google.load('search', '1', {language : 'es'});
    google.setOnLoadCallback(function() {
        var customSearchControl = new google.search.CustomSearchControl('008095775353890783041:z5grsg1hkxe');
        customSearchControl.setResultSetSize(google.search.Search.FILTERED_CSE_RESULTSET);
        var options = new google.search.DrawOptions();
        options.enableSearchboxOnly("http://www.google.com/cse?cx=008095775353890783041:z5grsg1hkxe");
        customSearchControl.draw('cse-search-form', options);
    }, true);
</script>