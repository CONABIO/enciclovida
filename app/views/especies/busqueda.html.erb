<script type="text/javascript" charset="utf-8" data-turbolinks-track="true">
    getCookie = function(c_name)
    {
        var c_end, c_start;
        c_end = void 0;
        c_start = void 0;
        if (document.cookie.length > 0)
        {
            c_start = document.cookie.indexOf(c_name + "=");
            if (c_start !== -1)
            {
                c_start = c_start + c_name.length + 1;
                c_end = document.cookie.indexOf(";", c_start);
                if (c_end === -1)
                {
                    c_end = document.cookie.length;
                }
                return unescape(document.cookie.substring(c_start, c_end));
            }
        }
        return "";
    };

    guardaBusquedas = function()
    {
        var busqueda={};
        var numerosFiltros='';
        var checkboxSeleccionadas='';
        var checkboxSeleccionadasEstatusBasicaComun='';
        var checkboxSeleccionadasEstatusBasicaCientifico='';
        var checkboxSeleccionadasEstatusAvanzada='';
        var busquedaAvanzada = $('#busqueda_basica').is(':visible') ? 'busqueda_basica' : 'busqueda_avanzada';

        $(".busqueda_atributo").each(function()
        {
            var id=$(this).attr('id');
            var valor=$(this).val();
            eval("busqueda."+id+"=\""+valor+"\"");
        });

        if ($("[id^='bAtributo_']").length > 0)
        {
            $("[id^='bAtributo_']").each(function()
            {
                if ($(this).attr('id') != 'bAtributo_1')
                {
                    var valor=$(this).attr('id').substring(10);
                    numerosFiltros+=valor+',';
                }
            });
            busqueda.adicionales=numerosFiltros.substring(0, numerosFiltros.length-1);
        }

        $(".busqueda_atributo_checkbox").each(function()
        {
            if ($(this).is(':checked'))
            {
                checkboxSeleccionadas+=$(this).val()+','
            }
        });

        $("[id^='estatus_']").each(function()
        {
            if ($(this).is(':checked'))
            {
                switch ($(this).attr('id'))
                {
                    case 'estatus_basica_cientifico_1':
                    case 'estatus_basica_cientifico_2':
                        checkboxSeleccionadasEstatusBasicaCientifico+=$(this).val()+','
                        break;
                    case 'estatus_avanzada_1':
                    case 'estatus_avanzada_2':
                        checkboxSeleccionadasEstatusAvanzada+=$(this).val()+','
                        break;
                }
            }
        });

        busqueda.tipoBusqueda = busquedaAvanzada;
        busqueda.estatusBasicaCientifico = checkboxSeleccionadasEstatusBasicaCientifico.substring(0, checkboxSeleccionadasEstatusBasicaCientifico.length-1);
        busqueda.estatusAvanzada = checkboxSeleccionadasEstatusAvanzada.substring(0, checkboxSeleccionadasEstatusAvanzada.length-1);
        busqueda.tipo_distribucion = checkboxSeleccionadas.substring(0, checkboxSeleccionadas.length-1);
        document.cookie = "busqueda_taxones=" + JSON.stringify(busqueda).replace(/"/g, "%22") + "; expires=Thu, 01 Jan 2050 00:00:01 GMT; path=/";
    }

    cargaBusquedas = function(atributos)
    {
        if (atributos.tipoBusqueda == 'busqueda_avanzada')
        {
            $('#'+atributos.tipoBusqueda).show();
            $('#busqueda_basica').hide();
        }

        if (atributos.adicionales !== "")
        {
            $.each(atributos.adicionales.split(','), function(){
                $('#atributos_extra').append(estructuraFiltro(this));
            });
        }

        $(".busqueda_atributo").each(function()
        {
            var id=$(this).attr('id');
            var id_num = id.split('_')[1];
            $(this).val(eval("atributos." + id));

            //alert(id.match(/^bAtributo_/g));

            if (id.match(/^bAtributo_/g) != null)
            {
                if ($(this).val() == 'nombre_cientifico')
                {
                    $('#vAtributo_' + id_num).attr('data-autocomplete', '/especies/autocomplete_especie_nombre').attr('autocomplete', 'off').addClass('ui-autocomplete-input');
                } else if ($(this).val() == 'nombre_comun')
                {
                    $('#vAtributo_' + id_num).attr('data-autocomplete', '/nombres_comunes/autocomplete_nombre_comun_comun').attr('autocomplete', 'off').addClass('ui-autocomplete-input');
                }
            }
        });

        if (atributos.tipo_distribucion !== "")
        {
            $.each(atributos.tipo_distribucion.split(','), function(k, v){
                $('#tipo_distribucion_'+v).attr('checked', true);
            });
        }

        if (atributos.estatusBasicaCientifico !== "")
        {
            $.each(atributos.estatusBasicaCientifico.split(','), function(k, v){
                $('#estatus_basica_cientifico_'+v).attr('checked', true);
            });
        }

        if (atributos.estatusAvanzada !== "")
        {
            $.each(atributos.estatusAvanzada.split(','), function(k, v){
                $('#estatus_avanzada_'+v).attr('checked', true);
            });
        }
    }

    estructuraFiltro = function(numeroAtributos)
    {
        var bAtributo, cAtributo, vAtributo, hAtributo, imagenQuitar, anteriores;
        bAtributo="<div id='capa_"+numeroAtributos+"'><select class='busqueda_atributo' name='bAtributo_"+numeroAtributos+"' id='bAtributo_"+numeroAtributos+"'>";
        bAtributo+="<option value='nombre_cientifico'>nombre científico</option>";
        bAtributo+="<option value='nombre_comun'>nombre común</option>";
        bAtributo+="<option value='nombre_region'>región</option>";
        bAtributo+="<option value='catalogos.descripcion'>característica del taxón</option>";
        bAtributo+="<option value='nombre_autoridad'>autoridad</option></select> ";

        cAtributo="<select class='busqueda_atributo' name='cAtributo_"+numeroAtributos+"' id='cAtributo_"+numeroAtributos+"'>";
        cAtributo+="<option value='1'>contiene</option>";
        cAtributo+="<option value='2'>empieza con</option>";
        cAtributo+="<option value='3'>igual a</option>";
        cAtributo+="<option value='4'>termina con</option></select> ";

        vAtributo="<input class='busqueda_atributo' name='vAtributo_"+numeroAtributos+"' id='vAtributo_"+numeroAtributos+"' size='35' maxlength='255' type='text' data-autocomplete='/especies/autocomplete_especie_nombre' autocomplete='off' />";
        hAtributo="<input class='busqueda_atributo' name='hAtributo_" + numeroAtributos + "' id='hAtributo_" + numeroAtributos + "' type='hidden' />";
        imagenQuitar="&nbsp;&nbsp;&nbsp;<a onClick='return quitaFiltros(this.id);' id='enlace_filtro_"+numeroAtributos+"' href=''><img src='/assets/app/24x24/delete.png' width='20px;'></a></div>";

        return bAtributo+cAtributo+vAtributo+hAtributo+imagenQuitar;
    }

    masFiltros = function()
    {
        var numeroAtributos=$("[id^='bAtributo_']").length +1;
        $('#atributos_extra').append(estructuraFiltro(numeroAtributos));
        guardaBusquedas();
        return false;
    }

    quitaFiltros = function(id)
    {
        $('#capa_'+id.substring(14)).html("");
        guardaBusquedas();
        return false;
    }

    busqueda_avanzada = function(id)
    {
        $('#busqueda_basica').slideUp();
        $('#busqueda_avanzada').slideDown();
        guardaBusquedas();
        return false;
    }

    busqueda_basica = function(id)
    {
        $('#busqueda_avanzada').slideUp();
        $('#busqueda_basica').slideDown();
        guardaBusquedas();
        return false;
    }

    quitaAutocompletar = function()
    {
        $("[id^='vAtributo_']").each(function()
        {
            var id=$(this).attr('id').split('_')[1];
            if ($('#bAtributo_' + id).val() != 'nombre_cientifico' && $('#bAtributo_' + id).val() != 'nombre_comun')
            {
                $(this).removeAttr('data-autocomplete').removeAttr('autocomplete').removeClass('ui-autocomplete-input');
            }
        });
    }

    $(document).ready(function()
    {
        var cookie=getCookie('busqueda_taxones');

        if (cookie == "")
        {
            guardaBusquedas();
        } else {
            cargaBusquedas(JSON.parse(cookie));
        }

        quitaAutocompletar();
        /*
         var countries = [
         { value: 'Andorra', data: 'AD' },
         { value: 'Zimbabwe', data: 'ZZ' }
         ];

         $('#nombre_cientifico2').autocomplete({
         lookup: countries,
         onSelect: function (suggestion) {
         alert('You selected: ' + suggestion.value + ', ' + suggestion.data);
         }
         });
         */

        $(document).on('change', ".busqueda_atributo, .busqueda_atributo_checkbox, .busqueda_atributo_checkbox_estatus", function()
        {
            guardaBusquedas();
            var id=$(this).attr('id').split('_')[1];
            if ($('#' + $(this).attr('id')).val() == 'nombre_cientifico')
            {
                $('#vAtributo_' + id).attr('data-autocomplete', '/especies/autocomplete_especie_nombre').attr('autocomplete', 'off').addClass('ui-autocomplete-input');
            } else if ($('#' + $(this).attr('id')).val() == 'nombre_comun')
            {
                $('#vAtributo_' + id).attr('data-autocomplete', '/nombres_comunes/autocomplete_nombre_comun_comun').attr('autocomplete', 'off').addClass('ui-autocomplete-input');
            } else {
                $('#vAtributo_' + id).removeAttr('data-autocomplete').removeAttr('autocomplete').removeClass('ui-autocomplete-input');
            }
        });

        $(document).on('railsAutocomplete.select', "[id^='vAtributo_']", function(event, data) {
            var id=$(this).attr('id').split('_')[1];

            if ($('#bAtributo_' + id).val() == 'nombre_cientifico')
            {
                $(this).val(data.item.nombre_cientifico);
                $('#hAtributo_' + id).val(data.item.id);
            } else {
                $(this).val('');
            }
            guardaBusquedas();
        });

        $(document).on('keyup', "[id^='vAtributo_']", function() {
            var id=$(this).attr('id').split('_')[1];
            $('#hAtributo_' + id).val('');
        });
    });
</script>

<table id="busqueda">
  <tr>
    <td width="60%" valign="top">
      <div id="busqueda_basica">
        <%= form_tag resultados_especies_path, :method => :get do %>
            <%= hidden_field_tag :busqueda_oculto, :basica_comun %>
            Nombre común<br>
            <%= select_tag :condicion_nombre_comun, busquedas(Especie::BUSQUEDAS_TEXTO).html_safe, :id => :condicion_nombre_comun, :class => :busqueda_atributo %>
            <%= text_field_tag :nombre_comun, nil, :maxlength => 255, :size => 45, :placeholder => 'nombre común', :id => :nombre_comun, :class => :busqueda_atributo %>
            <%= submit_tag :Buscar, data: { disable_with: 'Procesando...' } %>
        <% end %>
        <br>
        <%= form_tag resultados_especies_path, :method => :get do %>
            <%= hidden_field_tag :busqueda_oculto, :basica_cientifico %>
            Nombre científico<br>
            <%= select_tag :condicion_nombre_cientifico, busquedas(Especie::BUSQUEDAS_TEXTO).html_safe, :id => :condicion_nombre_cientifico, :class => :busqueda_atributo %>
            <%= text_field_tag :nombre_cientifico, nil, :maxlength => 255, :size => 45, :placeholder => 'nombre científico', :id => :nombre_cientifico, :class => :busqueda_atributo %>
            <%= submit_tag :Buscar, data: { disable_with: 'Procesando...' } %>
            <br>mostrar solo taxones:<br>
            <%= checkboxValidoSinonimo('basica_cientifico') %>
            <br><br><%= link_to '[Búsqueda avanzada]', '', :id => :busqueda_avanzada_link, :onClick => 'return busqueda_avanzada();' %> &#8595;
        <% end %>
      </div>

      <div id="busqueda_avanzada" style="display: none">
        <%= form_tag resultados_especies_path, :method => :get do %>
            <%= hidden_field_tag :busqueda_oculto, :avanzada %>
            <b>Buscar por</b><br>
            <div id="atributos_extra">
              <%= select_tag :bAtributo_1, busquedas(Especie::BUSQUEDAS_ATRIBUTO).html_safe, :class => :busqueda_atributo %>
              <%= select_tag :cAtributo_1, busquedas(Especie::BUSQUEDAS_TEXTO).html_safe, :class => :busqueda_atributo %>
              <%= text_field_tag :vAtributo_1, nil, :maxlength => 255, :size => 35, :class => :busqueda_atributo %>
              <%= hidden_field_tag :hAtributo_1, nil, :class => :busqueda_atributo %>
            </div>
            <!--div class="container">
                <div style="position: relative; height: 60px;">
                  <%=# text_field_tag :nombre_cientifico2, nil, :maxlength => 255, :size => 35, :style => 'position: absolute; z-index: 2; background: transparent;'
      %>
                </div>
              </div-->

            <%= link_to '[Añade más filtros]', '', :id => :enalce_mas_filtros, :onClick => 'return masFiltros();' %>
            <br><br><b>con tipo de distribución</b><br>
            <%= checkboxTipoDistribucion %>

            <table>
              <tr>
                <td>
                  <div style="text-align: left; display: inline-block"><b>con la categoria taxonómica igual a: </b><br><i>Puedes seleccionar mas de una. (Tecla Ctrl)</i></div>
                  <br><br><br><br><b>mostrar solo taxones:</b><br>
                  <%= checkboxValidoSinonimo('avanzada') %>
                  <br><br><br><br><%= submit_tag :Buscar, data: { disable_with: 'Procesando...' } %>
                  <br><%= link_to '[Búsqueda básica]', '', :id => :busqueda_basica_link, :onClick => 'return busqueda_basica();' %> &#8593;
                </td>
                <td>
                  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                  <%= select_tag :categoria_taxonomica, options_from_collection_for_select(CategoriaTaxonomica.select('nombre_categoria_taxonomica, nivel1').order('nivel1, nombre_categoria_taxonomica ASC').uniq, 'nombre_categoria_taxonomica', 'nombre_categoria_taxonomica'),
                                 :class => :busqueda_atributo, :multiple => true, :size => 15, :prompt => '---Categoria del tax&oacute;n (predeterminada)---'.html_safe %>
                </td>

            </table>
        <% end %>
      </div>

    </td>
    <td id="widget_busqueda" width="40%" valign="top">
    </td>
  </tr>
</table>

