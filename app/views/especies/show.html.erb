<% taxon = @especie.to_json %>
<% species_or_lower = @especie.species_or_lower? %>
<% geodatos = @especie.proveedor.geodatos if species_or_lower %>
<% geo = JSON.parse(geodatos) if geodatos %>

<style>
    #map
    {
        margin: 0px auto;
        padding: 0px;
    }
    #map.fullscreen
    {
        top: 0px;
        left: 0px;
        z-index: 10000;
    }
    #balloon
    {
        color: rgb(3, 7, 48);
        margin: 0px;
        padding: 0px;
        font-size: x-small;
        text-transform: capitalize;
        line-height: 1.6em;
    }
</style>

<script data-turbolinks-track="true" src="/assets/photo_selectors.js"></script>
<script data-turbolinks-track="true" type="text/javascript" charset="utf-8">
    var TAXON = <%=raw taxon %>;
    var SPECIES_OR_LOWER = <%=raw species_or_lower %>;

    if (SPECIES_OR_LOWER)
    {
        // Nos fijamos que si va a desplegar el mapa por lo menos tenga un kmz asociado
        var RUTAS_KMZ = eval(<%=raw geodatos %>);
        var CUANTOS_KMZ = Object.keys(RUTAS_KMZ).length;

        if (CUANTOS_KMZ > 0) {
            var MAPAS = new Array();

            if (RUTAS_KMZ.geoserver_kmz != undefined)
            {
                MAPAS[0] = new Array();
                MAPAS[0][0] = RUTAS_KMZ.geoserver_kmz
                MAPAS[0][1] = "Mapa de distribución"
            }

            if (RUTAS_KMZ.snib_kmz != undefined)
            {
                var CUANTOS = Object.keys(MAPAS).length;
                MAPAS[CUANTOS] = new Array();
                MAPAS[CUANTOS][0] = RUTAS_KMZ.snib_kmz
                MAPAS[CUANTOS][1] = "Registros de museos, colectas y proyectos de CONABIO (SNIB)"
            }

            if (RUTAS_KMZ.naturalista_kmz != undefined)
            {
                var CUANTOS = Object.keys(MAPAS).length;
                MAPAS[CUANTOS] = new Array();
                MAPAS[CUANTOS][0] = RUTAS_KMZ.naturalista_kmz
                MAPAS[CUANTOS][1] = "Observaciones de naturalista"
            }
        }
    }

    info = function()
    {
        $('#ficha-div').slideUp();
        $('#info-div').slideDown();
        return false;
    }

    ficha = function()
    {
        $('#info-div').slideUp();
        $('#ficha-div').slideDown();
        return false;
    }

    muestraBibliografiaNombres = function(ident)
    {
        var id=ident.split('_')[2];
        $("#biblio_"+id).dialog();
        return false;
    }

    getDescription = function(url)
    {
        $.ajax({
            url: url,
            method: 'get',
            beforeSend: function() {
                $('.taxon_description').loadingShades()
            },
            success: function(data, status) {
                $('.taxon_description').replaceWith(data);
                $('.taxon_description select').change(function() {
                    getDescription('/especies/'+TAXON.id+'/describe?from='+$(this).val())
                })
            },
            error: function(request, status, error) {
                $('.taxon_description').loadingShades('close')
            }
        })
    }

    $(document).ready(function()
    {
        $('#tabs').tabs(); // Inicia los tabs

        // Inicia los proveedores de fotos
        $('#edit_photos_dialog').dialog({
            modal: true,
            title: 'Escoge las fotos para este grupo o especie',
            autoOpen: false,
            width: 700,
            open: function( event, ui ) {
                $('#edit_photos_dialog').loadingShades('Cargando...', {cssClass: 'smallloading'})
                $('#edit_photos_dialog').load('/especies/'+TAXON.id+'/edit_photos', function() {
                    var photoSelectorOptions = {
                        defaultQuery: TAXON.nombre_cientifico,
                        skipLocal: true,
                        baseURL: '/conabio/photo_fields',
                        taxon_id: TAXON.id,
                        urlParams: {
                            authenticity_token: $('meta[name=csrf-token]').attr('content'),
                            limit: 14
                        },
                        afterQueryPhotos: function(q, wrapper, options) {
                            $(wrapper).imagesLoaded(function() {
                                $('#edit_photos_dialog').centerDialog()
                            })
                        }
                    };

                    $('.tabs', this).tabs({
                        beforeActivate: function( event, ui ) {
                            if ($(ui.newPanel).attr('id') == 'flickr_taxon_photos' && !$(ui.newPanel).hasClass('loaded')) {
                                //$('.taxon_photos', ui.newPanel).photoSelector(photoSelectorOptions)
                                $('.taxon_photos', ui.newPanel).photoSelector(
                                        $.extend(true, {}, photoSelectorOptions, {baseURL: '/flickr/photo_fields'})
                                )
                            } else if ($(ui.newPanel).attr('id') == 'inat_obs_taxon_photos' && !$(ui.newPanel).hasClass('loaded')) {
                                $('.taxon_photos', ui.newPanel).photoSelector(
                                        $.extend(true, {}, photoSelectorOptions, {baseURL: '/taxa/'+TAXON.id+'/observation_photos'})
                                )
                            } else if ($(ui.newPanel).attr('id') == 'eol_taxon_photos' && !$(ui.newPanel).hasClass('loaded')) {
                                $('.taxon_photos', ui.newPanel).photoSelector(
                                        $.extend(true, {}, photoSelectorOptions, {baseURL: '/eol/photo_fields'})
                                )
                            } else if ($(ui.newPanel).attr('id') == 'wikimedia_taxon_photos' && !$(ui.newPanel).hasClass('loaded')) {
                                $('.taxon_photos', ui.newPanel).photoSelector(
                                        $.extend(true, {}, photoSelectorOptions, {baseURL: '/wikimedia_commons/photo_fields'})
                                )
                            } else if ($(ui.newPanel).attr('id') == 'conabio_taxon_photos' && !$(ui.newPanel).hasClass('loaded')) {
                                $('.taxon_photos', ui.newPanel).photoSelector(
                                        $.extend(true, {}, photoSelectorOptions, {taxon_id: TAXON.id, baseURL: '/conabio/photo_fields'})
                                )
                            }

                            $(ui.newPanel).addClass('loaded')
                            $('#edit_photos_dialog').centerDialog()
                        },
                        create: function( event, ui) {
                            $('.taxon_photos', ui.panel).photoSelector(photoSelectorOptions);
                            $(ui.panel).addClass('loaded')
                            $('#edit_photos_dialog').centerDialog()
                        }
                    })
                })
            }
        });

        if (SPECIES_OR_LOWER)
        {
            getDescription('/especies/'+TAXON.id+'/describe'); // Inicia las fihas

            if (CUANTOS_KMZ > 0)
            {
                console.log(MAPAS);
                // Inicia el mapa
                map = new GMaps({
                    div: '#map',
                    zoom: 5,
                    lat: 23.79162789,
                    lng: -102.04376221,
                    mapTypeId: google.maps.MapTypeId.HYBRID,
                    height: "450px",
                    width: "450px"
                });

                for (var i = 0; i < MAPAS.length; i++) {
                    infoWindow = new google.maps.InfoWindow({});
                    MAPAS[i][2] = function (direccion) {
                        return map.loadFromKML({
                            url: direccion,
                            preserveViewport: true,
                            suppressInfoWindows: true,
                            events: {
                                click: function (point) {
                                    anchoInfo = function () {
                                        return parseInt($("#map").width() / 5) * 4;
                                    };
                                    altoInfo = function () {
                                        return parseInt($("#map").height() / 10) * 9;
                                    };
                                    if (point.featureData.infoWindowHtml.indexOf('$[description]') > -1) {
                                        infoWindow.setContent("<div id='balloon' style='max-height: " + altoInfo() + "px; max-width: " + anchoInfo() + "px;'>" + point.featureData.name + "</div>");
                                        infoWindow.maxWidth = 2;
                                    } else {
                                        infoWindow.setContent("<div id='balloon' style='max-height: " + altoInfo() + "px; max-width: " + anchoInfo() + "px;'>" + point.featureData.infoWindowHtml + "</div>");
                                    }
                                    ;
                                    infoWindow.setPosition(point.latLng);
                                    infoWindow.open(map.map);
                                    $(function () {
                                        $("#balloon div").removeAttr("style");
                                    });
                                }
                            }
                        });
                    }
                }

                anadeControlFullScreen();
                anadeControlCapas();
            }
        }
        <%# if (!@especie.species_or_lower? && @photos.size < 24) || @photos.blank? %>
        //$('#photos_loading_status').show()
        /*$('#photos').load('<%# taxon_photos_path(@especie) %>', function() {
     $('#modal_image_box').jqmAddTrigger('#photos a.modal_image_link')
     });*/
        <%# end %>
    });
</script>

<p id="notice"><%= notice %></p>

<% content_for(:title) do %>
    <%= @titulo = tituloNombreCientifico(@especie, :title => true) %>
<% end %>

<div class="titulo">
  <h1>
    <%= "#{tituloNombreCientifico(@especie, :show => true)}".html_safe %>
    <%= link_to(:Editar, edit_especy_path, :class => :link_azul, :style => 'font-size:12px;').html_safe if usuario_signed_in? %>
  </h1>
  <%= datos_principales(@especie).html_safe %>
  <br>Imprime la página en PDF <%= link_to(image_tag('app/pdf.png', :alt => :PDF), "#{especy_path(@especie)}.pdf", :target => :_blank) %>

  <% if geo && geo.count > 0 %>
      <%= "| Mapa de distribución #{link_to(image_tag('app/kmz.jpg', :alt => :KMZ, :width => 26), geo['geoserver_kmz'], :target => :_blank)}".html_safe if geo['geoserver_kmz'] %>
      <%= "| Registros del SNIB #{link_to(image_tag('app/kml.png', :alt => 'Registros de museos, colectas y proyectos de CONABIO (SNIB)', :width => 32, :height => 32), geo['snib_kml'], :target => :_blank)}".html_safe if geo['snib_kml'] %>
      <%= "| Observaciones de NaturaLista #{link_to(image_tag('app/kml.png', :alt => :KML, :width => 32, :height => 32), geo['naturalista_kml'], :target => :_blank)}".html_safe if geo['naturalista_kml'] %>
  <% end %>
  <!--| registros del SNIB <%# link_to(image_tag('app/kml.png', :alt => :KML, :width => 32, :height => 32), "#{root_url}especies/kmz?id=#{@especie.id}&kml=true", :target => :_blank) %>-->
</div>

<% if geo && geo.count > 0 %>
    <div style="width: 40%; float:left;">
<% else %>
    <div style="width: 100%; float:left;">
<% end %>

<div id="photoscol" class="column span-13">
  <div id="photos">
    <%= render :partial => 'photos', :locals => { :photos => @photos } %>
    <div id="photos_loading_status" class="loading status" style="display:none">Cargando más fotos...</div>
  </div>

  <% if usuario_signed_in? %>
      <%= link_to('Edita las fotos', nil, :onClick => "$('#edit_photos_dialog').dialog('open');return false;", :class => 'readmore') %>
      <div id="edit_photos_dialog" class="dialog" style="display: none"></div>
  <% end %>
</div>
</div>

<% if geo && geo.count > 0 %>
    <div style="width: 60%; float:right;">
      <div id="map"></div>
    </div>
<% end %>

<div id="tabs" style="width: 100%; float:left;">
  <% if I18n.locale.to_s == 'es-cientifico' %>
      <ul>
        <li><a href="#conabio_info"><span>Catálogos de CONABIO</span></a></li>
        <li><a href="#arbol_taxonomico"><span>&Aacute;rbol taxonómico</span></a></li>
        <%= "<li><a href=\"#description\"><span>Fichas</span></a></li>".html_safe if @especie.species_or_lower? %>
      </ul>

      <div id="conabio_info" class="last column span-20">
        <%= render :partial => 'info' %>
      </div>

      <div id="arbol_taxonomico" class="last column span-20">
        <%= render :partial => 'arbol' %>
      </div>

      <% if @especie.species_or_lower? %>
          <div id="description" class="last column span-20">
            <%= render :partial => 'description' %>
          </div>
      <% end %>
  <% else %>
      <ul>
        <%= "<li><a href=\"#description\"><span>Fichas</span></a></li>".html_safe if @especie.species_or_lower? %>
        <li><a href="#arbol_taxonomico"><span>&Aacute;rbol taxonómico</span></a></li>
        <li><a href="#conabio_info"><span>Catálogos de CONABIO</span></a></li>
      </ul>

      <% if @especie.species_or_lower? %>
          <div id="description" class="last column span-20">
            <%= render :partial => 'description' %>
          </div>
      <% end %>

      <div id="arbol_taxonomico" class="last column span-20">
        <%= render :partial => 'arbol' %>
      </div>

      <div id="conabio_info" class="last column span-20">
        <%= render :partial => 'info' %>
      </div>
  <% end %>
</div>
<!--div class="enlaces_acciones">
  <%# accionesEnlaces(@especie, @accion).html_safe %><br>
  <%# link_to("Nuevo taxón descendiente de #{@especie.nombre_cientifico}".html_safe,
              new_especy_path(:parent_id => @especie)).html_safe %>
</div-->
