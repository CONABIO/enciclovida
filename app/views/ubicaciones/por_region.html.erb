<% content_for(:extrajs) do %>
    <script src="//cdnjs.cloudflare.com/ajax/libs/chroma-js/0.5.9/chroma.min.js"></script>
    <%= javascript_include_tag 'geodatos/d3.v3.min', 'data-turbolinks-track' => true %>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <!--script src='http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js' data-turbolinks-track='true'></script-->
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <script src="http://leaflet.github.io/Leaflet.label/leaflet.label.js"></script>
    <%= javascript_include_tag 'geodatos/Control.FullScreen.js', 'data-turbolinks-track' => true %>
    <%= javascript_include_tag 'busquedas_espaciales/topojson', 'data-turbolinks-track' => true %>

    <script data-turbolinks-track="true">

        function addPointLayerGeoportal(){
            geojsonFeature =  { "type": "FeatureCollection",
                "features": allowedPoints.values()};

            markersLayer = L.markerClusterGroup({ maxClusterRadius: 30, chunkedLoading: true, which_layer: 'geoportal', chunkInterval: '2000', chunkDelay: 1});

            species_layer = L.geoJson(geojsonFeature, {
                pointToLayer: function (feature, latlng) {
                    // Este campos quiere decir que es de aves aves
                    if (feature.properties.d[1])
                        return L.circleMarker(latlng, geojsonMarkerGeoportalAveravesOptions);
                    //else if (fosil != undefined && fosil != "")
                    //  return L.circleMarker(latlng, geojsonMarkerGeoportalFosilOptions);
                    else  // de lo contrario es un registro rojo normal
                        return L.circleMarker(latlng, geojsonMarkerGeoportalOptions);
                },
                onEachFeature: function (feature, layer) {
                    layer.on("click", function (e) {
                        ejemplar_snib(layer, feature.properties.d[0]);
                    });
                }
            });

            markersLayer.addLayer(species_layer);
            map.addLayer(markersLayer);

            var punto_rojo = '<svg height="50" width="200"><circle cx="10" cy="10" r="6" stroke="black" stroke-width="1" stroke-opacity="1" fill="#FF0000"/>';
            punto_rojo+= '<text x="20" y="13">Registros del SNIB</text>';

            var punto_naranja = punto_rojo + '<circle cx="10" cy="25" r="6" stroke="black" stroke-width="1" stroke-opacity="1" fill="#FFA500"/>';
            punto_naranja+= '<text x="20" y="28">Registros de AverAves</text>';

            /*var punto_gris = punto_naranja + '<circle cx="10" cy="40" r="6" stroke="black" stroke-width="1" stroke-opacity="1" fill="#888888"/>';
             punto_gris+= '<text x="20" y="43">Registros de Fósiles</text></svg>';*/

            legend_control.addOverlay(markersLayer,
                    "<b>Registros del SNIB <sub>" + geoportal_count + "</sub><br /> (museos, colectas y proyectos)</b>" +
                    "<p>"+punto_naranja+"</p>"
            );
        }

        function ejemplar_snib(layer, id){
            $.ajax({
                url: "/especies/" + TAXON.id + "/ejemplar-snib/" + id,
                dataType : "json",
                success : function (res){
                    if (res.estatus == 'OK')
                    {
                        var ejemplar = res.ejemplar;
                        var contenido = "";

                        contenido += "<h4>" + name() + "</h4>";
                        contenido += "<dt>Localidad: </dt><dd>" + ejemplar.localidad + "</dd>";
                        contenido += "<dt>Municipio: </dt><dd>" + ejemplar.municipiomapa + "</dd>";
                        contenido += "<dt>Estado: </dt><dd>" + ejemplar.estadomapa + "</dd>";
                        contenido += "<dt>País: </dt><dd>" + ejemplar.paismapa + "</dd>";
                        contenido += "<dt>Fecha: </dt><dd>" + ejemplar.fechacolecta + "</dd>";
                        contenido += "<dt>Colector: </dt><dd>" + ejemplar.colector + "</dd>";
                        contenido += "<dt>Colección: </dt><dd>" + ejemplar.coleccion + "</dd>";
                        contenido += "<dt>Institución: </dt><dd>" + ejemplar.institucion + "</dd>";
                        contenido += "<dt>País de la colección: </dt><dd>" + ejemplar.paiscoleccion + "</dd>";

                        if (ejemplar.proyecto.length > 0 && ejemplar.urlproyecto.length > 0)
                            contenido += "<dt>Proyecto: </dt><dd><a href='" + ejemplar.urlproyecto + "' target='_blank'>" + ejemplar.proyecto + "</a></dd>";

                        contenido += "<dt>Más información: </dt><dd><a href='http://" + ejemplar.urlejemplar + "' target='_blank'>consultar</a></dd>";

                        // Para enviar un comentario acerca de un registro en particular
                        contenido += "<dt>¿Tienes un comentario?: </dt><dd><a href='/especies/" + TAXON.id + "/comentarios/new?proveedor_id=" + ejemplar.idejemplar + "&tipo_proveedor=6' target='_blank'>redactar</a></dd>";

                        contenido = "<dl class='dl-horizontal'>" + contenido + "</dl>" + "<strong>ID: </strong>" + ejemplar.idejemplar;
                    } else {
                        var contenido = "Hubo un error al retraer el ejemplar: " + res.msg;
                    }

                    // Pone el popup arriba del punto
                    var popup = new L.Popup();
                    var bounds = layer.getBounds();

                    popup.setLatLng(bounds.getCenter());
                    popup.setContent(contenido);
                    map.openPopup(popup);
                },
                error: function( jqXHR ,  textStatus,  errorThrown ){
                    console.log("error: " + textStatus);
                    console.log(errorThrown);
                    console.log(jqXHR.responseText);
                }
            });  // termina ajax
        }

        function name()
        {
            if (I18n.locale == 'es')
            {
                if (NOMBRE_COMUN_PRINCIPAL.length > 0)
                    return NOMBRE_COMUN_PRINCIPAL + " <a href='/especies/" + TAXON.id + "'><i>(" + TAXON.nombre_cientifico + ")</i></a>";
                else
                    return "<i>(" + TAXON.nombre_cientifico + ")</i>";
            } else {
                return "<i>(" + TAXON.nombre_cientifico + ")</i>";
            }
        }

        // Copyright (c) 2013 Ryan Clark
        // https://gist.github.com/rclark/5779673
        L.TopoJSON = L.GeoJSON.extend({
            addData: function(jsonData) {
                if (jsonData.type === "Topology") {
                    for (key in jsonData.objects) {
                        geojson = topojson.feature(jsonData, jsonData.objects[key]);
                        L.GeoJSON.prototype.addData.call(this, geojson);
                    }
                }
                else {
                    L.GeoJSON.prototype.addData.call(this, jsonData);
                }
            }
        });

        var cargaMapa = function (id)
        {
            var place = [23.79162789, -102.04376221];
            var tile_url = 'http://{s}.tile.osm.org/{z}/{x}/{y}.png';

            map = L.map(id, {
                zoomControl: false
            });

            var zoom = L.control.zoom({
                zoomInTitle: 'Acercarse',
                zoomOutTitle: 'Alejarse'
            });

            // https://github.com/brunob/leaflet.fullscreen
            var fullscreen = L.control.fullscreen({
                position: 'topleft',
                title: 'Pantalla completa',
                titleCancel: 'Salir de pantalla completa'
            });

            map.addControl(zoom);
            map.addControl(fullscreen);

            var layer = L.tileLayer(tile_url, {
                attribution: 'OSM',
                noWrap: true,
            });

            map.addLayer(layer);
            map.setView(place, 5);  // Default place and zoom

            // El layer general de las regiones
            topoLayer = new L.TopoJSON();

            // Para los controles de las divisiones
            //cargaControlDivisiones();
        };

        // Los controles de las divisiones politicas
        var cargaControlDivisiones = function ()
        {
            var topoLayerEstatal = new L.TopoJSON();
            var topoLayerMunicipal = new L.TopoJSON();
            var topoLayerAnp = new L.TopoJSON();
            var divisiones_control = L.control.layers({}, {}, {collapsed: false, position: 'bottomleft'}).addTo(map);

            $.getJSON('/topojson/estado.json', function(topojson){
                addTopoData({topojson: topojson, layer: topoLayerEstatal});
                divisiones_control.addOverlay(topoLayerEstatal, "Estatal");
            });

            divisiones_control.addOverlay(topoLayerMunicipal, "Municipal");
            divisiones_control.addOverlay(topoLayerAnp, "ANP");

            map.on('overlayadd', function(eo) {

                if (eo.layer.options.municipal == undefined)
                {
                    if (eo.name === 'Municipal'){
                        $.getJSON('/topojson/division_estatal.json', function(topojson){
                            topoLayerMunicipal.options.municipal = true;
                            addTopoData({topojson: topojson, layer: topoLayerMunicipal});
                        });
                    }
                }

                if (eo.layer.options.anp == undefined) {
                    if (eo.name === 'ANP') {
                        $.getJSON('/topojson/division_estatal.json', function (topojson) {
                            topoLayerAnp.options.anp = true;
                            addTopoData({topojson: topojson, layer: topoLayerAnp});
                        });
                    }
                }
            });
        };

        var cargaRegistros = function()
        {
            var geojsonFeature = [];
            var allowedPoints = d3.map([]);
            var geoportal_count = 0;

            var species_layer;
            var markersLayer;

            var geojsonMarkerGeoportalOptions = {
                radius: 5,
                fillColor: "#ff0000",
                color: "white",
                weight: 2,
                opacity: 1,
                fillOpacity: 0.6
            };

            var geojsonMarkerGeoportalAveravesOptions = {
                radius: 5,
                fillColor: "#FFA500",
                color: "black",
                weight: 2,
                opacity: 1,
                fillOpacity: 0.6
            };
        };

        var cargaTopojson = function(region)
        {
            // Cargo la capa de topojson en el mapa
            $.ajax({
                url: '/geojson-a-topojson',
                data: {region_id: region.val(), tipo_region: region.attr('id'), parent_id: region.attr('parent_id')}
            }).done(function(res) {
                if (res.estatus)
                {
                    if (res.cache)
                        $.getJSON(res.topojson, function(topojson){
                            addTopoData({topojson: topojson, layer: topoLayer, clean: true, fillColor: '#99ccff', color: '#3232ff'});
                        });

                    else
                        addTopoData({topojson: res.topojson, layer: topoLayer, clean: true});
                }
            }).fail(function() {
                console.log('Fallo la conversion del geojson a topojson');
            });
        };

        var cargaGrupos = function(region)
        {
            // Aqui pregunto con el servio de conteo de Abraham, y recibo una respuesta similar, espero
            var grupos = {};
            grupos["Algas"] = 0;
            grupos["Anfibios"] = 0;
            grupos["Aves"] = 0;
            grupos["Hongos"] = 0;
            grupos["Insectos"] = 0;
            grupos["Mamíferos"] = 0;
            grupos["Musgos"] = 0;
            grupos["Peces"] = 0;
            grupos["Plantas"] = 0;
            grupos["Reptiles"] = 0;

            var url = dameUrlCargaGrupos(region);
            if (url != '')
            {
                // Pregunto por la URL del servicio de abraham
                $.ajax({
                    url: url
                }).done(function(resp) {
                    grupos["Aves"] = resp.length;

                    $('#contenedor_grupos').empty();
                    $.each(grupos, function(grupo, valor){
                        $('#contenedor_grupos').append('<li class="list-group-item"><a href="" class="grupo_id" grupo_id="'+grupo+'">' + grupo + '</a><span class="badge">' + valor + '</span></li>');
                    });
                }).fail(function() {
                    console.log('Falló el servicio de conteo de Abraham');
                });
            }
        };

        var dameUrlCargaGrupos = function(region)
        {
            if (tipo_region == 'estado')
                return 'http://www.enciclovida.mx:9002/taxonEdo/conteo/' + region.attr('region_id') + '/edomun/aves?apiKey=enciclovida';

            else if (tipo_region == 'municipio')
                return 'http://www.enciclovida.mx:9002/taxonMuni/listado/' + region.attr('parent_id') + '/' + region.attr('region_id') + '/edomun/aves?apiKey=enciclovida';
            else
                return '';
        };

        var cargaEspecies = function(elemento, pagina, por_pagina)
        {
            // Aqui pregunto por la segunda parte del servicio de Abraham, esperando una respuesta similar
            var especies = {};
            especies["resultados"] = ["1077REPTI", "12780ANFIB", "12109MAMIF", "938REPTI", "19405GIMNO", "923REPTI",
                "1211REPTI", "491REPTI", "11881MAMIF", "963REPTI", "40198ANGIO", "14269AVES", "571REPTI", "13478AVES", "3659LEPID"];

            // Pregunta por los datos correspondientes a estas especies en nuestra base, todos deberian coincidir en teoria ya que son ids de catalogos, a excepcion de los nuevos, ya que aún no se actualiza a la base centralizada
            $.ajax({
                url: '/especies-por-catalogo-id',
                data: {catalogo_id: especies["resultados"]}
            }).done(function(resp) {
                if (resp.estatus)
                {
                    $.each(resp.resultados, function(index, taxon){
                        $('#contenedor_especies').append('<li class="list-group-item" snib_url="' + taxon.snib_mapa_json + '"><a href="" class="especie_id"><img src="' + taxon.foto+'"/>' + taxon.nombre_comun + ' (' + taxon.nombre_cientifico + ')</a></li>');
                    });
                }
                else
                    console.log('Falló la carga de especies de enciclovida');

            }).fail(function() {
                console.log('Falló la carga de especies de enciclovida');
            });
        };

        // Cargo las regiones en la lista de municipios
        var municipiosPorEstado = function(estado){
            $.ajax({
                url: '/municipios-por-estado',
                data: {region_id: estado.val()}
            }).done(function(res) {
                if (res.estatus)
                {
                    $('#region_municipio').empty().append('<option value>- - - Escoge un municipio - - -</option>');
                    $.each(res.resultados, function(index, municipio){
                        $('#region_municipio').append('<option value="' + municipio.region_id + '">' + municipio.nombre_region + '</option>');
                    });

                    $('#region_municipio').prop('disabled', false).attr('parent_id', res.parent_id);
                }
            }).fail(function() {
                console.log('Falló al cargar los municipios por estado');
            });
        };

        // Carga la division estatal de un inicio
        var cargaDivisionEstatal = function(d)
        {
            var svg = d3.select(map.getPanes().overlayPane).append('svg');
            var g = svg.append('g').attr('class', 'leaflet-zoom-hide');

            d3.json('/topojson/estado.json', function (error, collection) {
                var bounds = d3.geo.bounds(topojson.feature(collection, collection.objects['collection']));
                var path = d3.geo.path().projection(projectPoint);

                var feature = g.selectAll('.estatal')
                        .data(topojson.feature(collection, collection.objects['collection']).features)
                        .enter()
                        .append('path')
                        .attr('class', 'estatal leaflet-clickable')
                        .on('mouseover', function(d){
                            var name = d.properties.nombre_region;
                            $('#nombre_region').html(name);
                        })
                        .on('click', function(d){
                            $('#svg-division-municipal').remove();
                            map.flyTo(d.properties.centroide, 7);
                            cargaDivisionMunicipal(d);
                        });

                map.on('zoom', reset);
                reset();

                // Reposition the SVG to cover the features.
                function reset()
                {
                    var bottomLeft = projectPoint(bounds[0]);
                    var topRight = projectPoint(bounds[1]);

                    svg.attr('width', topRight[0] - bottomLeft[0])
                            .attr('height', bottomLeft[1] - topRight[1])
                            .style('margin-left', bottomLeft[0] + 'px')
                            .style('margin-top', topRight[1] + 'px');

                    var translation = -bottomLeft[0] + ',' + -topRight[1];
                    g.attr('transform', 'translate(' + -bottomLeft[0] + ',' + -topRight[1] + ')');
                    feature.attr('d', path);
                }

                // Use Leaflet to implement a D3 geographic projection.
                function projectPoint(x) {
                    var point = map.latLngToLayerPoint(new L.LatLng(x[1], x[0]));
                    return [point.x, point.y];
                }
            });
        };

        // Carga todos los municipios de cierto estado
        var cargaDivisionMunicipal = function(d){
            var svg = d3.select(map.getPanes().overlayPane).append('svg').attr('id', 'svg-division-municipal');
            var g = svg.append('g').attr('class', 'leaflet-zoom-hide');

            d3.json('/topojson/estado_' + d.properties.region_id + '_division_municipal.json', function (error, collection) {
                var bounds = d3.geo.bounds(topojson.feature(collection, collection.objects['collection']));
                var path = d3.geo.path().projection(projectPoint);

                var feature = g.selectAll('.estatal')
                        .data(topojson.feature(collection, collection.objects['collection']).features)
                        .enter()
                        .append('path')
                        .attr('class', 'estatal leaflet-clickable')
                        .on('mouseover', function(d){
                            var name = d.properties.nombre_region;
                            $('#nombre_region').html(name);
                        });
                        /*.on('click', function(d){
                            cargaDivisionMunicipal(d);
                        });*/

                map.on('zoom', reset);
                reset();

                // Reposition the SVG to cover the features.
                function reset()
                {
                    var bottomLeft = projectPoint(bounds[0]);
                    var topRight = projectPoint(bounds[1]);

                    svg.attr('width', topRight[0] - bottomLeft[0])
                            .attr('height', bottomLeft[1] - topRight[1])
                            .style('margin-left', bottomLeft[0] + 'px')
                            .style('margin-top', topRight[1] + 'px');

                    var translation = -bottomLeft[0] + ',' + -topRight[1];
                    g.attr('transform', 'translate(' + -bottomLeft[0] + ',' + -topRight[1] + ')');
                    feature.attr('d', path);
                }

                // Use Leaflet to implement a D3 geographic projection.
                function projectPoint(x) {
                    var point = map.latLngToLayerPoint(new L.LatLng(x[1], x[0]));
                    return [point.x, point.y];
                }
            });
        };
    </script>

<% end %>

<% content_for(:delayedjs) do %>
    <script>
        // variables del mapa y topojson
        map = null;
        topoLayer = null;
        cargaMapa('map');

        $('.contenedor_regiones').on('click', '.region_id', function(){
            //cargaTopojson($(this));
            cargaGrupos($(this));
            return false;
        });

        $('#contenedor_grupos').on('click', '.grupo_id', function(){
            cargaEspecies($(this));
            return false;
        });

        $('#contenedor_especies').on('click', '.especie_id', function(){
            //cargaRegistros($(this));
            return false;
        });

        $('.contenedor_regiones').on('scroll', function(){
            //if ($(this).height() + $(this).scrollTop() >= $(this)[0].scrollHeight)
        });

        /*
         Funciones con las listas y los checkbox
         */

        $('#regiones').on('change', '#region_estado', function(){
            if ($(this).val() == '')
            {
                $('#region_municipio').empty().append('<option value>- - - - - - - -</option>').prop('disabled', true);
                $('#region_anp').empty().append('<option value>- - - - - - - -</option>').prop('disabled', true);
                topoLayer.clearLayers();

            } else {
                municipiosPorEstado($(this));
                cargaTopojson($(this));
                //regionesAnp($(this));
            }
        });

        $('#regiones').on('change', '#region_municipio', function(){
            if ($(this).val() == '')
                topoLayer.clearLayers();
            else
                cargaTopojson($(this));
        });

        cargaDivisionEstatal();

    </script>
<% end %>

<% content_for(:extracss) do %>
    <!--link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" /-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
    <link rel="stylesheet" href="http://leaflet.github.io/Leaflet.label/leaflet.label.css" />
    <link rel="stylesheet" href="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.2/leaflet.draw.css" />
    <%= stylesheet_link_tag 'geodatos/MarkerCluster.Default', 'data-turbolinks-track' => true %>
    <%= stylesheet_link_tag 'geodatos/Control.FullScreen.css', 'data-turbolinks-track' => true %>
    <style>
        #map {
            height: 700px;
            width: 100%;
        }
        .contenedor_regiones {
            height: 600px;
            overflow: scroll;
        }
        #contenedor_especies img {
            height: 150px;
        }
        .estatal {
            fill: #e5e5e5;
            stroke: black;
            stroke-width:1px;
            opacity: .5;
	        pointer-events: all!important;

        }
        .estatal:hover {
            fill: steelblue;
        }
    </style>
<% end %>

<div id="regiones" class="col-md-4">
  <%= render partial: 'tipos_regiones' %>
  <div class="contenedor_regiones"></div>
</div>

<div><h1 id="nombre_region"></h1></div>
<div id="contenedor_mapa" class="col-md-8">
  <div id="map"></div>
</div>

<div id="grupos" class="col-md-12">
  <%= render partial: 'grupos' %>
</div>

<div id="especies" class="col-md-12">
  <%= render partial: 'especies' %>
</div>